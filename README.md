# Anonymization Pipeline

This repository implements a pipeline which aims to replicate the procedure used by Packhäuser _et al._ [[1]](#1). This pipeline aims to anonymize a synthetic dataset which has been previously generated by employing both a patient-retrieval model and a patient-verification model.

## Steps

This pipeline is composed of 4 different steps:
1. `compute_training_embeddings.py` - Using the **retrieval** model, for each real image in the training set we compute an embedding and store it in a lookup table. This lookup table is essentially a dictionary which matches a UID for each datum to its corresponding embedding.
2. `search_nearest_image.py` - At this step the real training data embeddings are stored in a KD-Tree for more efficient look-up. For each synthetic image we obtain an embedding using the **retrieval** model and search for the closest matches distance-wise in the training data. The output of this step is a csv file with pairs of images (synthetic - real) and their embedding distance.
3. `verify_images.py` - We compare each pair obtained in the last step using the **verification** model and store the prediction in a csv file.
4. `filter_dataset.py` - Finally based on a specified threshold we remove the non-anonymous images from the synthetic dataset. 

## References
<a id="1">[1]</a> 
K. Packhäuser, L. Folle, F. Thamm and A. Maier, "Generation of Anonymous Chest Radiographs Using Latent Diffusion Models for Training Thoracic Abnormality Classification Systems," 2023 IEEE 20th International Symposium on Biomedical Imaging (ISBI), Cartagena, Colombia, 2023, pp. 1-5, doi: 10.1109/ISBI53787.2023.10230346.
